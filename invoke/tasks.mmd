%%{init: {'theme':'neutral'}}%%
graph TD

%% ============================================================================
%% INPUT NODES
%% ============================================================================
I1[BWV000.ly<br/>ğŸ“„ Main Score]
I2[BWV000_ly_one_line.ly<br/>ğŸ“„ One-line Score]
I3[BWV000_ly_main.ly<br/>ğŸ“„ Shared Dependencies]
I4[BWV000_ties.csv<br/>ğŸ“„ Tied Notes Tuples]

%% ============================================================================
%% TASK NODES
%% ============================================================================
T1[build_pdf]
T2[build_svg]
T3[build_svg_one_line]
T4[post_process]
T5[prepare_swell]
T6[optimize_svg]
T7[extract_noteheads]
T8[extract_midi_timing]
T9[align_data]

%% ============================================================================
%% RUNNABLE NODES
%% ============================================================================
R1[docker run -v PWD:/work codello/lilypond:dev BWV000.ly<br/>ğŸ³ LilyPond PDF]
R2[docker run -v PWD:/work codello/lilypond:dev --svg BWV000.ly<br/>ğŸ³ LilyPond SVG]
R3[docker run -v PWD:/work codello/lilypond:dev --svg BWV000_ly_one_line.ly<br/>ğŸ³ LilyPond One-line SVG and MIDI]
R4[bwv_script:no_hrefs_in_tabs.py BWV000.svg<br/>ğŸ”— Remove tab links]
R5[bwv_script:ensure_swellable.py BWV000_no_hrefs_in_tabs.svg<br/>ğŸ¯ Animation prep]
R6[bwv_script:optimize.py BWV000_no_hrefs_in_tabs_swellable.svg<br/>âš¡ SVGO optimization]
R7[bwv_script:extract_note_heads.py BWV000_ly_one_line.svg<br/>ğŸ“ Extract notehead positions]
R8[bwv_script:extract_note_events.py BWV000_ly_one_line.midi<br/>â±ï¸ Extract MIDI timing]
R9[bwv_script:align_data.py BWV000_note_heads.csv BWV000_note_events.csv BWV000_ties.csv<br/>ğŸ¯ Align MIDIâ†”SVG]

%% ============================================================================
%% OUTPUT NODES
%% ============================================================================
O2[BWV000.svg<br/>ğŸ¼ Main SVG Score]
O3[BWV000_ly_one_line.svg<br/>ğŸ¼ One-line SVG]
O4[BWV000_ly_one_line.midi<br/>ğŸµ MIDI Data]
O5[BWV000_no_hrefs_in_tabs.svg<br/>ğŸ”„ Processed SVG]
O6[BWV000_no_hrefs_in_tabs_swellable.svg<br/>ğŸ¯ Animation-ready SVG]
O7[BWV000_note_heads.csv<br/>ğŸ“Š SVG Noteheads Data]
O8[BWV000_note_events.csv<br/>ğŸ“Š MIDI Events Data]

%% ============================================================================
%% EXPORT NODES
%% ============================================================================
E3[BWV000.pdf<br/>ğŸ“‘ PDF Output]
E1[exports/BWV000_optimized.svg<br/>ğŸ¨ Final Animated SVG]
E2[exports/BWV000_json_notes.json<br/>ğŸµ Synchronized Animation Data]

%% ============================================================================
%% DEPENDENCY RELATIONSHIPS
%% ============================================================================
%% Shared dependencies
I3 --> I1
I3 --> I2

%% Input to task relationships
I1 --> T1
I1 --> T2
I2 --> T3
I4 --> T9

%% Task to runnable relationships
T1 --> R1
T2 --> R2
T3 --> R3
T4 --> R4
T5 --> R5
T6 --> R6
T7 --> R7
T8 --> R8
T9 --> R9

%% Runnable to output relationships
R1 --> E3
R2 --> O2
R3 --> O3
R3 --> O4

%% SVG processing chain
O2 --> T4
R4 --> O5
O5 --> T5
R5 --> O6
O6 --> T6
R6 --> E1

%% Data extraction parallel branches
O3 --> T7
R7 --> O7
O4 --> T8
R8 --> O8

%% Final data alignment
O7 --> T9
O8 --> T9

%% Final export
R9 --> E2

%% ============================================================================
%% STYLING
%% ============================================================================
classDef input fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef task fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
classDef output fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
classDef runnable fill:#fff3e0,stroke:#e65100,stroke-width:2px
classDef export fill:#ffebee,stroke:#b71c1c,stroke-width:3px

class I1,I2,I3,I4 input
class T1,T2,T3,T4,T5,T6,T7,T8,T9 task
class O2,O3,O4,O5,O6,O7,O8 output
class R1,R2,R3,R4,R5,R6,R7,R8,R9 runnable
class E3,E1,E2 export

%% ============================================================================
%% BOTTOM ALIGNMENT HACK
%% ============================================================================
bottomAlign["ğŸŒ Published to Web"]
style bottomAlign fill:#ffffff,stroke:#ffffff

E1 --> bottomAlign
E2 --> bottomAlign
E3 --> bottomAlign